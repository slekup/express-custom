#!/usr/bin/env node
const fileTimeStart = Date.now();
import { exec } from 'child_process';
import colors from 'colors';
import fs from 'fs';
import path from 'path';
import { promisify } from 'util';
import { PackageError } from '@utils/index';
import getRawConfig from './utils/getRawConfig';
import loadApi from './utils/loadApi';
import logInfo from './utils/logInfo';
import logger, { cli, site } from './utils/logger';
const debug = process.argv.includes('--debug');
if (debug)
    logger.info(`${cli.inf} ${colors.magenta('Debug mode enabled')}`);
/**
 * Export the routes to a JSON file.
 * @param apiData The API data.
 */
const exportRoutes = async (apiData) => {
    const timeStart = Date.now();
    logger.info(`${cli.inf} Exporting routes to JSON file`);
    try {
        // Write the routes to a JSON file in the site directory
        await fs.promises.writeFile(path.join(__dirname, '../../site/api.json'), JSON.stringify(apiData, null, 2));
        const time = `${Date.now() - timeStart}ms`;
        logger.info(`${cli.suc} ⚡ Exported routes in ${time}`);
    }
    catch (error) {
        logger.error(`${cli.err} Failed to export routes`);
        logger.error(error);
    }
};
/**
 * Install the dependencies for the site.
 */
const installSiteDependencies = async () => {
    const timeStart = Date.now();
    logger.info(`${cli.inf} Installing site dependencies`);
    if (fs.existsSync('../../site/node_modules')) {
        logger.info(`${cli.inf} Copying node_modules ${colors.yellow('please wait')}}`);
        await fs.promises.cp(path.join(__dirname, '../../site/node_modules'), '../site/node_modules');
    }
    try {
        const { stdout, stderr } = await promisify(exec)('npm install', {
            cwd: path.join(__dirname, '../site'),
            // shell: true,
        });
        if (stdout && debug)
            logger.info(stdout);
        if (stderr) {
            logger.error(`${site.err} Error occurred while installing site dependencies`);
            logger.error(stderr);
        }
        const time = `${Date.now() - timeStart}ms`;
        logger.info(`${site.suc} ⚡ Site install dependencies success in ${time}`);
    }
    catch (error) {
        logger.error(`${site.err} Failed to install site dependencies`);
        logger.error(error.stack);
        process.exit(1);
    }
};
/**
 * Build the static site with next.js.
 */
const buildSite = async () => {
    const timeStart = Date.now();
    logger.info(`${cli.inf} Building static site (${colors.yellow('please wait')})`);
    try {
        const { stdout, stderr } = await promisify(exec)('npx next build', {
            cwd: path.join(__dirname, '../site'),
            // shell: true,
        });
        if (stdout && debug)
            logger.info(stdout);
        if (stderr) {
            logger.error(`${site.err} Error occurred while building site`);
            logger.error(stderr);
        }
        const time = `${Date.now() - timeStart}ms`;
        logger.info(`${site.suc} ⚡ Build success in ${time}`);
    }
    catch (error) {
        logger.error(`${site.err} Failed to build site`);
        logger.error(error.stack);
        process.exit(1);
    }
};
/**
 * Copy the site to the ouput directory.
 * @param apiData The API data.
 */
const copySite = async (apiData) => {
    const timeStart = Date.now();
    logger.info(`${cli.inf} Copying site to ${apiData.output}`);
    const targetPath = path.join(process.cwd(), apiData.output);
    const targetPathOut = path.join(process.cwd(), `${apiData.output}/out`);
    // Make ouput directory if it doesn't exist
    if (!fs.existsSync(targetPath))
        await fs.promises.mkdir(targetPath);
    if (!fs.existsSync(targetPathOut))
        await fs.promises.mkdir(targetPathOut);
    try {
        // Copy the site to the ouput directory
        await fs.promises.cp(path.join(__dirname, '../site/out'), targetPath);
        // Copy the api.json file to the out directory
        await fs.promises.copyFile(path.join(__dirname, '../site/api.json'), path.join(__dirname, '../site/out/api.json'));
        const time = `${Date.now() - timeStart}ms`;
        logger.info(`${cli.suc} ⚡ Copied site in ${time}`);
    }
    catch (error) {
        logger.error(`${cli.err} Failed to copy site to ${apiData.output}`);
        throw new PackageError(error);
    }
};
/**
 * Main function.
 */
const main = async () => {
    const rawConfig = await getRawConfig();
    const apiData = await loadApi(rawConfig.file);
    await exportRoutes(apiData);
    await installSiteDependencies();
    await buildSite();
    await copySite(apiData);
    logInfo(apiData, fileTimeStart, 'Generated site');
    process.exit(1);
};
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2Vuc2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9iaW4vZ2Vuc2l0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBRWpDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckMsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUdqQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzVDLE9BQU8sWUFBWSxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQ3RDLE9BQU8sT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQ3RDLE9BQU8sTUFBTSxFQUFFLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5ELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRS9DLElBQUksS0FBSztJQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFN0U7OztHQUdHO0FBQ0gsTUFBTSxZQUFZLEdBQUcsS0FBSyxFQUFFLE9BQW9CLEVBQWlCLEVBQUU7SUFDakUsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzdCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBRXhELElBQUk7UUFDRix3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QUFNLElBQUksWUFBWSxDQUFDLEtBQWUsQ0FBQyxDQUFDO0tBQ3pDO0FBQ0gsQ0FBQyxDQUFDO0FBRUY7O0dBRUc7QUFDSCxNQUFNLElBQUksR0FBRyxLQUFLLElBQW1CLEVBQUU7SUFDckMsTUFBTSxTQUFTLEdBQUcsTUFBTSxZQUFZLEVBQUUsQ0FBQztJQUN2QyxNQUFNLE9BQU8sR0FBRyxNQUFNLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsTUFBTSxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDNUIsTUFBTSx1QkFBdUIsRUFBRSxDQUFDO0lBQ2hDLE1BQU0sU0FBUyxFQUFFLENBQUM7SUFDbEIsTUFBTSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDeEIsT0FBTyxDQUFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUNsRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUMsQ0FBQztBQUVGLElBQUksRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxyXG5cclxuY29uc3QgZmlsZVRpbWVTdGFydCA9IERhdGUubm93KCk7XHJcblxyXG5pbXBvcnQgeyBleGVjIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XHJcbmltcG9ydCBjb2xvcnMgZnJvbSAnY29sb3JzJztcclxuaW1wb3J0IGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gJ3V0aWwnO1xyXG5cclxuaW1wb3J0IHsgRXhwb3J0ZWRBcGkgfSBmcm9tICdAdHlwaW5ncy9leHBvcnRzJztcclxuaW1wb3J0IHsgUGFja2FnZUVycm9yIH0gZnJvbSAnQHV0aWxzL2luZGV4JztcclxuaW1wb3J0IGdldFJhd0NvbmZpZyBmcm9tICcuL3V0aWxzL2dldFJhd0NvbmZpZyc7XHJcbmltcG9ydCBsb2FkQXBpIGZyb20gJy4vdXRpbHMvbG9hZEFwaSc7XHJcbmltcG9ydCBsb2dJbmZvIGZyb20gJy4vdXRpbHMvbG9nSW5mbyc7XHJcbmltcG9ydCBsb2dnZXIsIHsgY2xpLCBzaXRlIH0gZnJvbSAnLi91dGlscy9sb2dnZXInO1xyXG5cclxuY29uc3QgZGVidWcgPSBwcm9jZXNzLmFyZ3YuaW5jbHVkZXMoJy0tZGVidWcnKTtcclxuXHJcbmlmIChkZWJ1ZykgbG9nZ2VyLmluZm8oYCR7Y2xpLmluZn0gJHtjb2xvcnMubWFnZW50YSgnRGVidWcgbW9kZSBlbmFibGVkJyl9YCk7XHJcblxyXG4vKipcclxuICogRXhwb3J0IHRoZSByb3V0ZXMgdG8gYSBKU09OIGZpbGUuXHJcbiAqIEBwYXJhbSBhcGlEYXRhIFRoZSBBUEkgZGF0YS5cclxuICovXHJcbmNvbnN0IGV4cG9ydFJvdXRlcyA9IGFzeW5jIChhcGlEYXRhOiBFeHBvcnRlZEFwaSk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gIGNvbnN0IHRpbWVTdGFydCA9IERhdGUubm93KCk7XHJcbiAgbG9nZ2VyLmluZm8oYCR7Y2xpLmluZn0gRXhwb3J0aW5nIHJvdXRlcyB0byBKU09OIGZpbGVgKTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIC8vIFdyaXRlIHRoZSByb3V0ZXMgdG8gYSBKU09OIGZpbGUgaW4gdGhlIHNpdGUgZGlyZWN0b3J5XHJcbiAgICBhd2FpdCBmcy5wcm9taXNlcy53cml0ZUZpbGUoXHJcbiAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9zaXRlL2FwaS5qc29uJyksXHJcbiAgICAgIEpTT04uc3RyaW5naWZ5KGFwaURhdGEsIG51bGwsIDIpXHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IHRpbWUgPSBgJHtEYXRlLm5vdygpIC0gdGltZVN0YXJ0fW1zYDtcclxuICAgIGxvZ2dlci5pbmZvKGAke2NsaS5zdWN9IOKaoSBFeHBvcnRlZCByb3V0ZXMgaW4gJHt0aW1lfWApO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoYCR7Y2xpLmVycn0gRmFpbGVkIHRvIGV4cG9ydCByb3V0ZXNgKTtcclxuICAgIGxvZ2dlci5lcnJvcihlcnJvcik7XHJcbiAgfVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIEluc3RhbGwgdGhlIGRlcGVuZGVuY2llcyBmb3IgdGhlIHNpdGUuXHJcbiAqL1xyXG5jb25zdCBpbnN0YWxsU2l0ZURlcGVuZGVuY2llcyA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICBjb25zdCB0aW1lU3RhcnQgPSBEYXRlLm5vdygpO1xyXG4gIGxvZ2dlci5pbmZvKGAke2NsaS5pbmZ9IEluc3RhbGxpbmcgc2l0ZSBkZXBlbmRlbmNpZXNgKTtcclxuXHJcbiAgaWYgKGZzLmV4aXN0c1N5bmMoJy4uLy4uL3NpdGUvbm9kZV9tb2R1bGVzJykpIHtcclxuICAgIGxvZ2dlci5pbmZvKFxyXG4gICAgICBgJHtjbGkuaW5mfSBDb3B5aW5nIG5vZGVfbW9kdWxlcyAke2NvbG9ycy55ZWxsb3coJ3BsZWFzZSB3YWl0Jyl9fWBcclxuICAgICk7XHJcbiAgICBhd2FpdCBmcy5wcm9taXNlcy5jcChcclxuICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL3NpdGUvbm9kZV9tb2R1bGVzJyksXHJcbiAgICAgICcuLi9zaXRlL25vZGVfbW9kdWxlcydcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICB0cnkge1xyXG4gICAgY29uc3QgeyBzdGRvdXQsIHN0ZGVyciB9ID0gYXdhaXQgcHJvbWlzaWZ5KGV4ZWMpKCducG0gaW5zdGFsbCcsIHtcclxuICAgICAgY3dkOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vc2l0ZScpLFxyXG4gICAgICAvLyBzaGVsbDogdHJ1ZSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChzdGRvdXQgJiYgZGVidWcpIGxvZ2dlci5pbmZvKHN0ZG91dCk7XHJcbiAgICBpZiAoc3RkZXJyKSB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgICBgJHtzaXRlLmVycn0gRXJyb3Igb2NjdXJyZWQgd2hpbGUgaW5zdGFsbGluZyBzaXRlIGRlcGVuZGVuY2llc2BcclxuICAgICAgKTtcclxuICAgICAgbG9nZ2VyLmVycm9yKHN0ZGVycik7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdGltZSA9IGAke0RhdGUubm93KCkgLSB0aW1lU3RhcnR9bXNgO1xyXG4gICAgbG9nZ2VyLmluZm8oYCR7c2l0ZS5zdWN9IOKaoSBTaXRlIGluc3RhbGwgZGVwZW5kZW5jaWVzIHN1Y2Nlc3MgaW4gJHt0aW1lfWApO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoYCR7c2l0ZS5lcnJ9IEZhaWxlZCB0byBpbnN0YWxsIHNpdGUgZGVwZW5kZW5jaWVzYCk7XHJcbiAgICBsb2dnZXIuZXJyb3IoKGVycm9yIGFzIHsgc3RhY2s6IHN0cmluZyB9KS5zdGFjayk7XHJcbiAgICBwcm9jZXNzLmV4aXQoMSk7XHJcbiAgfVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIEJ1aWxkIHRoZSBzdGF0aWMgc2l0ZSB3aXRoIG5leHQuanMuXHJcbiAqL1xyXG5jb25zdCBidWlsZFNpdGUgPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgY29uc3QgdGltZVN0YXJ0ID0gRGF0ZS5ub3coKTtcclxuICBsb2dnZXIuaW5mbyhcclxuICAgIGAke2NsaS5pbmZ9IEJ1aWxkaW5nIHN0YXRpYyBzaXRlICgke2NvbG9ycy55ZWxsb3coJ3BsZWFzZSB3YWl0Jyl9KWBcclxuICApO1xyXG5cclxuICB0cnkge1xyXG4gICAgY29uc3QgeyBzdGRvdXQsIHN0ZGVyciB9ID0gYXdhaXQgcHJvbWlzaWZ5KGV4ZWMpKCducHggbmV4dCBidWlsZCcsIHtcclxuICAgICAgY3dkOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vc2l0ZScpLFxyXG4gICAgICAvLyBzaGVsbDogdHJ1ZSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChzdGRvdXQgJiYgZGVidWcpIGxvZ2dlci5pbmZvKHN0ZG91dCk7XHJcbiAgICBpZiAoc3RkZXJyKSB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihgJHtzaXRlLmVycn0gRXJyb3Igb2NjdXJyZWQgd2hpbGUgYnVpbGRpbmcgc2l0ZWApO1xyXG4gICAgICBsb2dnZXIuZXJyb3Ioc3RkZXJyKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB0aW1lID0gYCR7RGF0ZS5ub3coKSAtIHRpbWVTdGFydH1tc2A7XHJcbiAgICBsb2dnZXIuaW5mbyhgJHtzaXRlLnN1Y30g4pqhIEJ1aWxkIHN1Y2Nlc3MgaW4gJHt0aW1lfWApO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoYCR7c2l0ZS5lcnJ9IEZhaWxlZCB0byBidWlsZCBzaXRlYCk7XHJcbiAgICBsb2dnZXIuZXJyb3IoKGVycm9yIGFzIHsgc3RhY2s6IHN0cmluZyB9KS5zdGFjayk7XHJcbiAgICBwcm9jZXNzLmV4aXQoMSk7XHJcbiAgfVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIENvcHkgdGhlIHNpdGUgdG8gdGhlIG91cHV0IGRpcmVjdG9yeS5cclxuICogQHBhcmFtIGFwaURhdGEgVGhlIEFQSSBkYXRhLlxyXG4gKi9cclxuY29uc3QgY29weVNpdGUgPSBhc3luYyAoYXBpRGF0YTogRXhwb3J0ZWRBcGkpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICBjb25zdCB0aW1lU3RhcnQgPSBEYXRlLm5vdygpO1xyXG4gIGxvZ2dlci5pbmZvKGAke2NsaS5pbmZ9IENvcHlpbmcgc2l0ZSB0byAke2FwaURhdGEub3V0cHV0fWApO1xyXG5cclxuICBjb25zdCB0YXJnZXRQYXRoID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIGFwaURhdGEub3V0cHV0KTtcclxuICBjb25zdCB0YXJnZXRQYXRoT3V0ID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIGAke2FwaURhdGEub3V0cHV0fS9vdXRgKTtcclxuXHJcbiAgLy8gTWFrZSBvdXB1dCBkaXJlY3RvcnkgaWYgaXQgZG9lc24ndCBleGlzdFxyXG4gIGlmICghZnMuZXhpc3RzU3luYyh0YXJnZXRQYXRoKSkgYXdhaXQgZnMucHJvbWlzZXMubWtkaXIodGFyZ2V0UGF0aCk7XHJcbiAgaWYgKCFmcy5leGlzdHNTeW5jKHRhcmdldFBhdGhPdXQpKSBhd2FpdCBmcy5wcm9taXNlcy5ta2Rpcih0YXJnZXRQYXRoT3V0KTtcclxuXHJcbiAgdHJ5IHtcclxuICAgIC8vIENvcHkgdGhlIHNpdGUgdG8gdGhlIG91cHV0IGRpcmVjdG9yeVxyXG4gICAgYXdhaXQgZnMucHJvbWlzZXMuY3AocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3NpdGUvb3V0JyksIHRhcmdldFBhdGgpO1xyXG5cclxuICAgIC8vIENvcHkgdGhlIGFwaS5qc29uIGZpbGUgdG8gdGhlIG91dCBkaXJlY3RvcnlcclxuICAgIGF3YWl0IGZzLnByb21pc2VzLmNvcHlGaWxlKFxyXG4gICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vc2l0ZS9hcGkuanNvbicpLFxyXG4gICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vc2l0ZS9vdXQvYXBpLmpzb24nKVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCB0aW1lID0gYCR7RGF0ZS5ub3coKSAtIHRpbWVTdGFydH1tc2A7XHJcbiAgICBsb2dnZXIuaW5mbyhgJHtjbGkuc3VjfSDimqEgQ29waWVkIHNpdGUgaW4gJHt0aW1lfWApO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoYCR7Y2xpLmVycn0gRmFpbGVkIHRvIGNvcHkgc2l0ZSB0byAke2FwaURhdGEub3V0cHV0fWApO1xyXG4gICAgdGhyb3cgbmV3IFBhY2thZ2VFcnJvcihlcnJvciBhcyBzdHJpbmcpO1xyXG4gIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiBNYWluIGZ1bmN0aW9uLlxyXG4gKi9cclxuY29uc3QgbWFpbiA9IGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICBjb25zdCByYXdDb25maWcgPSBhd2FpdCBnZXRSYXdDb25maWcoKTtcclxuICBjb25zdCBhcGlEYXRhID0gYXdhaXQgbG9hZEFwaShyYXdDb25maWcuZmlsZSk7XHJcbiAgYXdhaXQgZXhwb3J0Um91dGVzKGFwaURhdGEpO1xyXG4gIGF3YWl0IGluc3RhbGxTaXRlRGVwZW5kZW5jaWVzKCk7XHJcbiAgYXdhaXQgYnVpbGRTaXRlKCk7XHJcbiAgYXdhaXQgY29weVNpdGUoYXBpRGF0YSk7XHJcbiAgbG9nSW5mbyhhcGlEYXRhLCBmaWxlVGltZVN0YXJ0LCAnR2VuZXJhdGVkIHNpdGUnKTtcclxuICBwcm9jZXNzLmV4aXQoMSk7XHJcbn07XHJcblxyXG5tYWluKCk7XHJcbiJdfQ==