import ae from"dotenv";import ue from"express";import H from"fs";import J from"path";import W from"colors";import h from"colors";import*as c from"winston";var z=!!process.env.DEBUG,G=i=>{switch(i){case"error":return h.red(i.toUpperCase());case"warn":return h.yellow(i.toUpperCase());case"info":return h.green(i.toUpperCase());case"debug":return h.blue(i.toUpperCase());case"trace":return h.magenta(i.toUpperCase());default:return h.white(i.toUpperCase())}},Z=c.format.combine(c.format.colorize(),c.format.timestamp(),c.format.ms(),c.format.errors({stack:!0}),c.format.printf(({timestamp:i,ms:e,level:t,message:n,stack:a})=>{let r=n;a&&(r+=`
${a}`);let s=/\u001b\[[0-9]{1,2}m/gi;return`${h.gray(i)} (${h.magenta(e)}) [${G(t.replace(s,""))}]: ${r}`})),_=c.createLogger({level:"debug",format:Z,transports:[new c.transports.Console({level:z?"debug":"info"}),new c.transports.Console({level:"error"}),new c.transports.Console({level:"warn"}),new c.transports.Console({level:"trace"})]}),f=_;var j=i=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i),I=i=>/^[a-zA-Z0-9_]{3,16}$/.test(i),A=i=>/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/.test(i),O=i=>/^\d{10}$/.test(i),F=i=>/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4}$/.test(i);var L=i=>{try{return new URL(i).href===i}catch{return!1}},U=i=>/^\/(?:[a-zA-Z0-9_]+\/)?[a-zA-Z0-9_]*$/.test(i),D=i=>{try{return new URL(i).href===i}catch{return!1}};function Q(i,e,t){e.status(404).json({status:404,message:"The server cannot find the requested resource"}),f.error(W.red(`The route at ${i.originalUrl} was not found - ${i.method}`)),t()}function X(i,e,t){f.error(i),t.status(i.status||500),t.json({error:{status:i.status||500,message:"Internal Server Error",field:i.field}})}var V={notFound:Q,errorHandler:X};import{startSession as K}from"mongoose";var Y=async(i,e,t,n)=>{let a=await K();try{a.startTransaction(),await i(e,t,a),await a.commitTransaction(),n()}catch(r){await a.abortTransaction(),f.error(r),t.status(500).json({error:"Internal Server Error"})}finally{a.endSession()}},k=i=>(e,t,n)=>{Y(i,e,t,n)};import x from"colors";import*as d from"winston";var b={inf:x.blue("CLI"),suc:x.green("CLI"),err:x.red("CLI")},Be={inf:x.blue("SITE"),suc:x.green("SITE"),err:x.red("SITE")},ee=d.format.combine(d.format.colorize(),d.format.errors({stack:!0}),d.format.printf(({message:i,stack:e})=>{let t=i;return e&&(t+=`
${e}`),t})),te=d.createLogger({level:"info",format:ee,transports:[new d.transports.Console({level:"info"})]}),g=te;import re,{Router as se}from"express";import{rateLimit as ie}from"express-rate-limit";var m=class{raw;ratelimit;middlewares;constructor(e="router"){e==="app"?this.raw=re():this.raw=se(),this.middlewares=[]}setRateLimit(e,t){if(this.ratelimit)throw new Error("Rate limit already set.");return(t||t===void 0)&&(this.ratelimit={statusCode:e.statusCode??429,...typeof e.windowMs=="number"?{window:e.windowMs}:{},...typeof e.max=="number"?{max:e.max}:{}}),this.raw.use(ie(e)),this}addMiddleware(e){return this.middlewares.push(e),this.raw.use(e),this}};var p=class{name;description;required;checks;structure;defaultValue;constructor(){this.name="Name not provided",this.description="Description not provided",this.required=!1,this.checks=[]}setName(e){return this.name=e,this}setDescription(e){return this.description=e,this}setRequired(e){return this.required=e,this}addCheck(e){return this.checks.push(e),this}setStructure(e){return this.structure=e,this}};var w=class extends p{type="array";min;max;unique;contains;items;constructor(){super()}setMin(e){return this.min=e,this}setMax(e){return this.max=e,this}setUnique(e){return this.unique=e,this}setContains(e,t,n){return this.contains={type:e,...t?{min:t}:{},...n?{max:n}:{}},this}setItems(e){return this.items=e,this}setDefault(e){return this.defaultValue=e,this}export(){return{type:this.type,name:this.name,description:this.description,required:this.required,structure:this.structure,max:this.max,min:this.min,unique:this.unique}}};var v=class extends p{type="boolean";constructor(){super()}setDefault(e){return this.defaultValue=e,this}export(){return{type:this.type,name:this.name,description:this.description,required:this.required,structure:this.structure}}};var S=class extends p{type="image";constructor(){super()}export(){return{type:this.type,name:this.name,description:this.description,required:this.required,structure:this.structure}}};var y=class extends p{type="integer";min;max;constructor(){super()}setMin(e){return this.min=e,this}setMax(e){return this.max=e,this}setDefault(e){return this.defaultValue=e,this}export(){return{type:this.type,name:this.name,description:this.description,required:this.required,structure:this.structure}}};var R=class extends p{type="number";min;max;constructor(){super()}setMin(e){return this.min=e,this}setMax(e){return this.max=e,this}setDefault(e){return this.defaultValue=e,this}export(){return{type:this.type,name:this.name,description:this.description,required:this.required,structure:this.structure}}};var E=class extends p{type="object";properties;constructor(){super(),this.properties={}}setProperties(e){return this.properties=e,this}setDefault(e){return this.defaultValue=e,this}export(){return{type:this.type,name:this.name,description:this.description,required:this.required,structure:this.structure}}};var T=class extends p{type="string";min;max;options;test;constructor(){super()}setMin(e){return this.min=e,this}setMax(e){return this.max=e,this}setOptions(e){return this.options=e,this}setTest(e){return this.test=e,this}setDefault(e){return this.defaultValue=e,this}export(){return{type:this.type,name:this.name,description:this.description,required:this.required,structure:this.structure}}};var l=class{schema;constructor(){this.schema={}}addArray(e){let t=new w;return e(t),this.schema[t.name]=t,this}addString(e){let t=new T;return e(t),this.schema[t.name]=t,this}addNumber(e){let t=new R;return e(t),this.schema[t.name]=t,this}addInteger(e){let t=new y;return e(t),this.schema[t.name]=t,this}addBoolean(e){let t=new v;return e(t),this.schema[t.name]=t,this}addObject(e){let t=new E;return e(t),this.schema[t.name]=t,this}addImage(e){let t=new S;return e(t),this.schema[t.name]=t,this}async validateBase(e,t,n){if(typeof e!="object")return"The data provided must be an object.";let a=Object.entries(t);for(let[r,s]of a){if(s.required){if(!e[r]&&s.defaultValue){e[r]=s.defaultValue;break}else if(!e[r])return`The field "${r}" has not been provided.`}if(!e[r]&&s.defaultValue)return e[r]=s.defaultValue,!1;if(!e[r])return!1}for(let[r,s]of a)if(typeof e[r]!==s.type)return`The field "${r}" must be of type ${s.type}.`;for(let[r,s]of a){if(s.type==="number"){if(s.min&&s.max&&typeof e[r]=="number"&&(e[r]<s.min||e[r]>s.max))return`The field "${r}" must be between ${s.min} and ${s.max}.`;if(s.min&&typeof e[r]=="number"&&e[r]<s.min)return`The field "${r}" must be at least ${s.min}.`;if(s.max&&typeof e[r]=="number"&&e[r]>s.max)return`The field "${r}" must be less than ${s.max}.`}if(s.type==="integer"){if(s.min&&s.max&&typeof e[r]=="number"&&(e[r]<s.min||e[r]>s.max))return`The field "${r}" must be between ${s.min} and ${s.max}.`;if(s.min&&typeof e[r]=="number"&&e[r]<s.min)return`The field "${r}" must be at least ${s.min}.`;if(s.max&&typeof e[r]=="number"&&e[r]>s.max)return`The field "${r}" must be less than ${s.max}.`;if(typeof e[r]!="number"||!Number.isInteger(e[r]))return`The field "${r}" must be an integer.`}if(s.type==="string"){let o=s,u=e[r];if(s.options&&!s.options.includes(e[r]))return`The field "${r}" is not a valid option.`;if(s.min&&s.max&&(u.length<s.min||u.length>s.max))return`The field "${r}" must be between ${s.min} and ${s.max} characters.`;if(s.min&&u.length<s.min)return`The field "${r}" must be at least ${s.min} characters.`;if(s.max&&u.length>s.max)return`The field "${r}" must be less than ${s.max} characters.`;if(o.test==="email"&&!j(u))return`The field "${r}" must be a valid email address.`;if(o.test==="username"&&!I(u))return`The field "${r}" must be a valid username.`;if(o.test==="passwordStrength"&&!A(u))return`The field "${r}" is too weak to be a valid password.`;if(o.test==="phoneNumber"&&!O(u))return`The field "${r}" must be a valid phone number.`;if(o.test==="ipAddress"&&!F(u))return`The field "${r}" must be a valid IPv4 address.`;if(o.test==="url"&&!L(u))return`The field "${r}" must be a valid IPv4 address.`;if(o.test==="path"&&!U(u))return`The field "${r}" must be a valid path.`;if(typeof e[r]!="string")return`The field "${r}" must be a string.`}if(s.checks){for(let o of s.checks)if(!await o.run(r))return`${o.response}.`}if(s.type==="boolean"&&typeof e[r]!="boolean")return`The field "${r}" must be a boolean.`;if(s.type==="object"){if(typeof e[r]!="object")return`The field "${r}" must be an object.`;if(s.properties&&Object.keys(s.properties).length>0){let o=await this.validateBase(e[r],s.properties,!0);if(o)return o}}if(s.type==="array"&&!Array.isArray(e[r]))return`The field "${r}" must be an array.`;if(s.type==="image"){if(typeof e[r]!="string")return`The field "${r}" must be a string.`;if(!D(e[r]))return`The field "${r}" must be a valid image.`}}return!1}async validate(e,t){let n=await this.validateBase(e,this.schema);return typeof n!="string"?null:t?.res?t.res.status(400).json({status:400,message:n}):n}export(){let e={};return Object.entries(this.schema).forEach(([t,n])=>{let a=n.export();e[t]=a}),e}};var $=class extends m{port;versions;routers;baseUrl;structures;config;constructor({baseUrl:e,port:t,structures:n}){super("app"),new l().addString(r=>r.setName("baseUrl").setRequired(!0).setMin(1).setMax(100)).addNumber(r=>r.setName("port").setMin(0).setMax(65536).setRequired(!0)).validate({baseUrl:e,port:t}).then(r=>{if(typeof r=="string")throw new Error(r)}),this.versions=[],this.routers=[],this.baseUrl=e,this.port=t,this.structures=n??[],this.config=void 0}addVersion(e){this.versions.push(e);let t=e.values();return this.raw.use(t.path,t.raw),this}addRouter(e){this.routers.push(e);let t=e.values();return this.raw.use(t.path,t.raw),this}startServer(e){return this.validate(),this.raw.get("/",(n,a)=>a.json({message:"Welcome to Slekup API",versions:this.versions.map(r=>({version:`v${r.values().version}`,url:`${this.baseUrl}/v${r.values().version}`}))})),this.raw.use(V.notFound),this.raw.use(V.errorHandler),this.raw.listen(this.port,e)}async loadConfig(){let e={},t=J.join(process.cwd(),"express-custom.json");try{let o=await H.promises.readFile(t,"utf-8");try{e=JSON.parse(o.toString())}catch(u){throw g.error(`${b.err} Failed to parse config.json file (invalid JSON).`),new Error(u)}}catch{g.error(`${b.err} No express-custom.json found, trying package.json`);try{let u=await H.promises.readFile(J.join(process.cwd(),"package.json"));try{let B=JSON.parse(u.toString())["express-custom"];if(typeof B!="object")throw g.error(`${b.err} Failed to parse express-custom.json (invalid JSON or no "express-custom" block)`),new Error("Invalid JSON");e=B}catch(B){throw g.error(`${b.err} Failed to parse express-custom.json (invalid JSON or no "express-custom" block)`),new Error(B)}}catch(u){throw g.error(`${b.err} Failed to load express-custom config from package.json`),new Error(u)}}let n=/\.ts$|\.js$/,r=await new l().addString(o=>o.setName("file").setRequired(!0).setMax(256).addCheck({run:u=>n.test(u),response:"The file must be a JavaScript or TypeScript file (.js or .ts)."})).addString(o=>o.setName("output").setDefault("docs").setMax(256)).addString(o=>o.setName("name").setDefault("My API")).addString(o=>o.setName("description").setDefault("Made with Express Custom")).addString(o=>o.setName("logo").setDefault("/logo.png")).addString(o=>o.setName("customDir").setMax(256)).addString(o=>o.setName("theme").setDefault("default")).addString(o=>o.setName("codeTheme").setDefault("framer")).addObject(o=>o.setName("socials").setDefault({}).setProperties({discord:{type:"string"},github:{type:"string"},instagram:{type:"string"},facebook:{type:"string"},linkedin:{type:"string"},youtube:{type:"string"},twitter:{type:"string"},email:{type:"string"}})).validate(e);typeof r=="string"&&(g.error(`${b.err} Validation error while processing express-config.json`),g.error(`${b.err} Error: ${r}`),process.exit(1));let s=e;return this.config=s,s}async getConfig(){return this.config?this.config:await this.loadConfig()}async validate(){if(this.versions.length===0||this.routers.length===0)throw new Error("No versions or routers provided to the API");await this.loadConfig()}async export(){if(!this.baseUrl)throw new Error("The base URL of the API is not set.");if(!this.port)throw new Error("The port of the API is not set.");return{...await this.loadConfig(),baseUrl:this.baseUrl,port:this.port,structures:this.structures,rateLimit:this.ratelimit,versions:this.versions.map(t=>t.export()),routers:this.routers.map(t=>t.export())}}};var N=class{disabled;name;description;path;method;notes;paramSchema;querySchema;bodySchema;responses;controller;ratelimit;constructor({disabled:e,name:t,description:n,path:a,method:r}){new l().addBoolean(o=>o.setName("disabled").setRequired(!1).setDefault(!1)).addString(o=>o.setName("name").setRequired(!0).setMin(1).setMax(50)).addString(o=>o.setName("description").setRequired(!0).setMin(1).setMax(100)).addString(o=>o.setName("path").setRequired(!0).setMin(1).setMax(100).setTest("path")).addString(o=>o.setName("method").setRequired(!0).setMin(1).setMax(100).setOptions(["GET","POST","PATCH","PUT","DELETE","OPTIONS"])).validate({disabled:e,name:t,description:n,path:a,method:r}).then(o=>{if(typeof o=="string")throw new Error(`Endpoint (${t||a}): ${o}`)}),this.disabled=e??!1,this.name=t,this.description=n,this.path=a,this.method=r,this.notes=[],this.responses=[],this.controller=()=>{throw new Error("Controller not set")}}setNotes(e){return this.notes=e,this}setParamSchema(e){let t=new l;return e(t),this.paramSchema=t,this}setQuerySchema(e){let t=new l;return e(t),this.querySchema=t,this}setBodySchema(e){let t=new l;return e(t),this.bodySchema=t,this}setResponses(e){return this.responses=e,this}setController(e){return this.controller=k(e),this}execute(e,t,n){(async()=>{try{return!this.paramSchema&&!this.querySchema&&!this.bodySchema?t.status(500).json({status:500,message:"Schema not set for endpoint."}):this.paramSchema&&await this.paramSchema.validate(e.params,{res:t})||this.querySchema&&await this.querySchema.validate(e.query,{res:t})||this.bodySchema&&await this.bodySchema.validate(e.body,{res:t})?void 0:this.controller(e,t,n)}catch(a){f.error(a)}})()}export(){return{name:this.name,description:this.description,path:this.path==="/"?"":this.path,method:this.method,notes:this.notes,params:this.paramSchema?this.paramSchema.export():{},queries:this.querySchema?this.querySchema.export():{},body:this.bodySchema?this.bodySchema.export():{},responses:this.responses}}};import{Router as oe}from"express";var C=class extends m{raw=oe();path;name;description;endpoints=[];constructor({path:e,name:t,description:n}){super(),new l().addString(r=>r.setName("path").setRequired(!0).setMin(1).setMax(100).setTest("path")).addString(r=>r.setName("name").setRequired(!0).setMin(1).setMax(50)).addString(r=>r.setName("description").setRequired(!0).setMin(1).setMax(1e3)).validate({name:t,description:n,path:e}).then(r=>{if(typeof r=="string")throw new Error(`Route (${t||e}): ${r}`)}),this.path=e,this.name=t,this.description=n}addEndpoint(e){this.endpoints.push(e);let t=/\/+/g,n=`${this.path}${e.path}`.replaceAll(t,"/");switch(e.method){case"GET":this.raw.get(n,e.controller);break;case"POST":this.raw.post(n,e.controller);break;case"PUT":this.raw.put(n,e.controller);break;case"PATCH":this.raw.patch(n,e.controller);break;case"DELETE":this.raw.delete(n,e.controller);break;case"OPTIONS":this.raw.options(n,e.controller);break;default:throw new Error(`Invalid method ${String(e.method)}`)}return this}addEndpointFile(e){for(let t of Object.values(e))this.addEndpoint(t);return this}validate(){if(this.endpoints.length===0)throw new Error(`Route ${this.name} has no endpoints`)}export(){return{name:this.name,description:this.description,path:this.path,endpoints:this.endpoints.map(e=>e.export())}}};var q=class extends m{path;name;routes;constructor({path:e,name:t}){super(),new l().addString(a=>a.setName("path").setRequired(!0).setMin(1).setMax(100).setTest("path")).addString(a=>a.setName("name").setRequired(!0).setMin(1).setMax(50)).validate({path:e,name:t}).then(a=>{if(typeof a=="string")throw new Error(`Router (${t||e}): ${a}`)}),this.path=e,this.name=t,this.routes=[]}addRoute(e){return this.routes.push(e),this.raw.use(this.path,e.raw),this}values(){return{raw:this.raw,ratelimit:this.ratelimit,path:this.path,defaultCategory:this.name,routes:this.routes,middlewares:this.middlewares}}validate(){if(!this.routes.length)throw new Error("No routes provided");this.routes.forEach(e=>e.validate())}export(){return{name:this.name,path:this.path,routes:this.routes.map(e=>e.export())}}};var P=class{name;type;fields;constructor({name:e,type:t,fields:n}){this.name=e,this.type=t,this.fields=n}export(){return{name:this.name,type:this.type,fields:this.fields}}};import ne from"express-rate-limit";var M=class extends m{version;routers;constructor({version:e}){super("app"),new l().addNumber(n=>n.setName("version").setRequired(!0).setMin(1).setMax(1e4)).validate({version:e}).then(n=>{if(typeof n=="string")throw new Error(n)}),this.routers=[],this.version=e}setRateLimit(e,t){return(t||t===void 0)&&(this.ratelimit={statusCode:e.statusCode??429,...typeof e.windowMs=="number"?{window:e.windowMs}:{},...typeof e.max=="number"?{max:e.max}:{}}),this.raw.use(`v${this.version}`,ne(e)),this}addRouter(e){this.routers.push(e);let t=e.values();return this.raw.use(`v${this.version}`,t.raw),this}export(){return{version:this.version,rateLimit:this.ratelimit,routers:this.routers.map(e=>e.export())}}values(){return{path:`/v${this.version}`,raw:this.raw,version:this.version}}validate(){if(!this.routers.length)throw new Error("No routers provided");this.routers.forEach(e=>e.validate())}};ae.config();var Lt=ue;export{$ as ApiBuilder,N as EndpointBuilder,C as RouteBuilder,q as RouterBuilder,l as SchemaBuilder,P as StructureBuilder,M as VersionBuilder,Lt as default};
//# sourceMappingURL=index.mjs.map